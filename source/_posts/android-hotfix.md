title: 利用动态加载修复已发布上线的apk的bug
date: 2014-12-17 14:56:38
tags: [android,hotfix,动态加载]
category: android开发
---
## 前言
传统意义上的Android程序，一旦上线，就像泼出去的水，没办法再去修改了，要升级只能再发布一个新版本。再加上android市场碎片化的原因，用户主动更新新版本的频率不像IOS那样。就算你发布了修复BUG的新版本，也有很大一批用户不主动更新。

那么，问题来了，版本发布后，发现有很严重的BUG怎么办？

<!-- more -->

## 后悔药
服务端的程序，出了问题，赶紧修复一下，一部署，就立刻搞定了。在android中，假如某个类出了问题，能不能将有问题的类替换一下，达到hotfix的目的。

其实后悔药还是有的，这就要用到动态加载技术了。关于动态加载，可以参考之前的BLOG [探究支付宝android客户端的动态加载](/2014/09/29/alipay-dynamic_load/ "探究支付宝android客户端的动态加载")

## hotfix原理
加载某类时，优先从补丁的dex文件中加载，没有再从原API的dex文件中加载。先看一下原理及操作流程。

- 编写动态加载代码，参考之前的BLOG。
- 在工程中将BUG修复后，将有改动的类打成dex(先编译，打成jar，再用dx命令转成dex文件)。
- 利用动态加载，将补丁dex的类运行时加载
- 这里要着重讲一下混淆。通常的程序，在编译后，会调用proguard对字节码进行混淆，为了方便跟踪，通常会生成一个mapping.txt的文件，保存映射关系。当我们修复Bug打补丁的时候，还需要利用这个mapping文件，以保证未动过的代码还和之前一样。

## 说明
需要注意的是R文件id常量的引用，有用id常量的地方要注意每次编译的值，防止冲突，可以利用public.xml(public资源)

另外，只能用于紧急BUG的修复，不要用于版本升级。

修复bug时候，不要增加资源。



